<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÅäË≤∑„ÅÑÁâ©„É™„Çπ„Éà</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Â∑¶ÂÅ¥: chat -->
        <div class="left">
            <h2>Ë≤∑„ÅÑ„Åü„ÅÑ„ÇÇ„ÅÆüéÅ</h2>
            <div>
                <input type="text" id="uname" placeholder="Ë®òÂÖ•ËÄÖ">
            </div>
            <div>
                <textarea id="text" placeholder="Ë≤∑„ÅÑ„Åü„ÅÑ„ÇÇ„ÅÆ" cols="30" rows="10"></textarea>
                <input type="text" id="amazonUrl" placeholder="Amazon URL">
                <button id="send">ÈÄÅ‰ø°</button>
            </div>
            <div id="output"></div>
        </div>

        <!-- Âè≥ÂÅ¥: bought -->
        <div class="right">
            <h2>Ë≤∑„Å£„Åü„ÇÇ„ÅÆüëç</h2>
            <div id="boughtOutput"></div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, push, set, update, remove, onChildAdded, onChildChanged, onChildRemoved } 
    from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "",
        authDomain: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: ""
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "chat");
    const boughtRef = ref(db, "bought");

    $("#send").on("click", function() {
        const uname = $("#uname").val().trim() || "Ë®òÂÖ•ËÄÖÔºö„Å™„Åó";
        const text = $("#text").val().trim() || "Ë≤∑„ÅÑ„Åü„ÅÑ„ÇÇ„ÅÆÔºö„Å™„Åó";
        const amazonUrl = $("#amazonUrl").val().trim() || "AmazonÔºö„Å™„Åó";

        const msg = {
            uname: uname,
            text: text,
            amazonUrl: amazonUrl,
            timestamp: new Date().toLocaleString()
        };

        const newPostRef = push(chatRef);
        set(newPostRef, msg);
    });

    $("#output").on("click", ".complete", function() {
        const key = $(this).attr("data-key");
        const timestamp = new Date().toLocaleString();
        const msg = {
            uname: $("#" + key + '_uname').text(),
            text: $("#" + key + '_text').text(),
            amazonUrl: $("#" + key + '_url').text(),
            timestamp: $("#" + key + '_timestamp').text(),
            completedAt: timestamp
        };
        const moveRef = push(boughtRef);
        set(moveRef, msg);
        remove(ref(db, "chat/" + key));
    });

    onChildAdded(chatRef, function(data) {
        const msg = data.val();
        const key = data.key;
        let amazonUrlHtml = msg.amazonUrl;
        let amazonPreviewHtml = '';
        
        if (msg.amazonUrl.startsWith("http")) {
            amazonUrlHtml = `<a href="${msg.amazonUrl}" target="_blank">${msg.amazonUrl}</a>`;
            amazonPreviewHtml = `<div class="amazon-preview" id="preview-${key}"></div>`;
            fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(`https://www.amazon.co.jp/gp/rss/${msg.amazonUrl}`)}`)
                .then(response => response.json())
                .then(data => {
                    const imageUrl = data.items[0]?.image_url;
                    if (imageUrl) {
                        $(`#preview-${key}`).html(`<img src="${imageUrl}" alt="AmazonÂïÜÂìÅÁîªÂÉè" class="amazon-image">`);
                    }
                });
        }

        let h = `<p id="${key}" class="chat-item">
                    <span class="timestamp" id="${key}_timestamp">${msg.timestamp}</span>
                    <span class="update" data-key="${key}">Êõ¥Êñ∞</span>
                    <span class="complete" data-key="${key}">ÂÆå‰∫Ü</span>
                    <span class="remove" data-key="${key}">ÂâäÈô§</span><br>
                    <span id="${key}_uname" contentEditable="true">${msg.uname}</span><br>
                    <span id="${key}_text" contentEditable="true">${msg.text}</span><br>
                    <span id="${key}_url" contentEditable="true">${amazonUrlHtml}</span><br>
                    ${amazonPreviewHtml}
                 </p>`;
        $("#output").prepend(h);
    });

    onChildAdded(boughtRef, function(data) {
        const msg = data.val();
        const key = data.key;
        let amazonUrlHtml = msg.amazonUrl;
        if (msg.amazonUrl.startsWith("http")) {
            amazonUrlHtml = `<a href="${msg.amazonUrl}" target="_blank">${msg.amazonUrl}</a>`;
        }
        let h = `<p id="${key}" class="bought-item">
                    <span class="timestamp">${msg.timestamp}</span>
                    <span class="remove" data-key="${key}">ÂâäÈô§</span><br>
                    <span>${msg.uname}</span><br>
                    <span>${msg.text}</span><br>
                    <span>${amazonUrlHtml}</span><br>
                    <span class="timestamp">${msg.completedAt} ÂÆå‰∫Ü</span><br>
                    </p>`;
        $("#boughtOutput").prepend(h);
    });

    $("#output").on("click", ".remove", function() {
        const key = $(this).attr("data-key");
        remove(ref(db, "chat/" + key));
    });

    $("#output").on("click", ".update", function() {
        const key = $(this).attr("data-key");
        update(ref(db, "chat/" + key), {
            text: $("#" + key + '_text').html()
        });
    });

    onChildRemoved(chatRef, function(data) {
        $("#" + data.key).remove();
    });

    onChildChanged(chatRef, function(data) {
        $("#" + data.key + '_text').html(data.val().text);
        $("#" + data.key + '_text').fadeOut(800).fadeIn(800);
    });

    </script>
</body>
</html>
